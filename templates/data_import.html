{% extends "base.html" %}

{% block title %}Import Data - RateEdge{% endblock %}

{% block content %}
<div class="tool-page">
    <div class="tool-header">
        <h1>üì§ Import Swap Rate Data</h1>
        <p>Upload Excel files to import swap rate data into the database</p>
    </div>

    <div class="import-container">
        <div class="upload-section">
            <div class="upload-box" id="upload-box">
                <div class="upload-icon">üìÅ</div>
                <h3>Drag and drop Excel file here</h3>
                <p>or</p>
                <button class="btn-primary" onclick="document.getElementById('file-input').click()">Browse Files</button>
                <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
                <p class="file-info">Supported formats: .xlsx, .xls</p>
            </div>
        </div>

        <div class="status-section">
            <h2>Import Status</h2>
            <div id="status-container" class="status-box">
                <p class="placeholder">No import in progress</p>
            </div>
        </div>

        <div class="history-section">
            <h2>Recent Imports</h2>
            <div id="history-container" class="history-box">
                <p class="placeholder">No import history</p>
            </div>
        </div>
    </div>
</div>

<style>
.import-container { max-width: 1200px; margin: 0 auto; }
.upload-section { margin-bottom: 2rem; }
.upload-box { background: white; border: 2px dashed #ddd; border-radius: 12px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.3s; }
.upload-box:hover { border-color: #4f46e5; background: #f9fafb; }
.upload-box.dragover { border-color: #4f46e5; background: #eef2ff; }
.upload-icon { font-size: 4rem; margin-bottom: 1rem; }
.upload-box h3 { margin-bottom: 0.5rem; }
.file-info { margin-top: 1rem; color: #666; font-size: 0.9rem; }
.status-section, .history-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
.status-box, .history-box { min-height: 150px; padding: 1.5rem; background: #f9fafb; border-radius: 8px; }
.progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 1rem 0; }
.progress-fill { height: 100%; background: #4f46e5; transition: width 0.3s; }
.import-result { padding: 1rem; background: white; border-radius: 8px; margin-bottom: 0.5rem; }
.success { color: #059669; background: #d1fae5; }
.error { color: #dc2626; background: #fee2e2; }
</style>
{% endblock %}

{% block scripts %}
<script>
const uploadBox = document.getElementById('upload-box');
const fileInput = document.getElementById('file-input');
const statusContainer = document.getElementById('status-container');

// Drag and drop handlers
uploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
});

uploadBox.addEventListener('dragleave', () => {
    uploadBox.classList.remove('dragover');
});

uploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleFile(files[0]);
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) handleFile(e.target.files[0]);
});

async function handleFile(file) {
    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        statusContainer.innerHTML = '<div class="error">Please upload an Excel file (.xlsx or .xls)</div>';
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    statusContainer.innerHTML = `
        <div class="import-result">
            <strong>Importing:</strong> ${file.name}
            <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
            <p>Processing...</p>
        </div>
    `;

    // Animate progress bar
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 5;
        if (progress <= 90) {
            document.querySelector('.progress-fill').style.width = progress + '%';
        }
    }, 100);

    try {
        const response = await fetch('/api/import', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        clearInterval(progressInterval);
        document.querySelector('.progress-fill').style.width = '100%';

        if (data.success) {
            const result = data.data;
            statusContainer.innerHTML = `
                <div class="import-result success">
                    <h3>‚úÖ Import Successful!</h3>
                    <p><strong>File:</strong> ${file.name}</p>
                    <p><strong>Records Imported:</strong> ${result.records_imported || 0}</p>
                    <p><strong>Currency:</strong> ${result.currency || 'N/A'}</p>
                    <p><strong>Date Range:</strong> ${result.date_range || 'N/A'}</p>
                </div>
            `;
            // Reload statistics
            setTimeout(() => window.location.href = '/data/view', 2000);
        } else {
            statusContainer.innerHTML = `
                <div class="import-result error">
                    <h3>‚ùå Import Failed</h3>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        clearInterval(progressInterval);
        statusContainer.innerHTML = `
            <div class="import-result error">
                <h3>‚ùå Import Failed</h3>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }
}
</script>
{% endblock %}
