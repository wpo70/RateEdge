{% extends "base.html" %}

{% block title %}View Data - RateEdge{% endblock %}

{% block content %}
<div class="tool-page">
    <div class="tool-header">
        <h1>ðŸ“Š Swap Rate Data</h1>
        <p>View and filter swap rate data</p>
    </div>

    <div class="data-controls">
        <div class="filter-section">
            <h2>Filters</h2>
            
            <!-- Quick Time Period Buttons -->
            <div class="time-filters">
                <label>Quick Period:</label>
                <div class="btn-group">
                    <button class="btn-time" data-period="1d">1 Day</button>
                    <button class="btn-time" data-period="1w">1 Week</button>
                    <button class="btn-time" data-period="1m">1 Month</button>
                    <button class="btn-time" data-period="3m">3 Months</button>
                    <button class="btn-time" data-period="6m">6 Months</button>
                    <button class="btn-time" data-period="ytd">YTD</button>
                    <button class="btn-time" data-period="1y">1 Year</button>
                    <button class="btn-time" data-period="all">All Time</button>
                </div>
            </div>

            <div class="filters">
                <div class="form-group">
                    <label>Currency</label>
                    <select id="filter-currency" class="form-control">
                        <option value="">All Currencies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tenor</label>
                    <select id="filter-tenor" class="form-control">
                        <option value="">All Tenors</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="filter-start-date" class="form-control">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="filter-end-date" class="form-control">
                </div>
            </div>
            <button id="apply-filters" class="btn-primary">Apply Filters</button>
            <button id="clear-filters" class="btn-secondary">Clear</button>
            <button id="export-csv" class="btn-secondary">Export CSV</button>
        </div>

        <div class="stats-section">
            <h2>Statistics</h2>
            <div id="stats-container" class="stats-box">
                <p class="placeholder">Loading statistics...</p>
            </div>
        </div>
    </div>

    <div class="data-table-section">
        <div class="table-header">
            <h2>Data <span id="record-count"></span></h2>
            <div class="table-controls">
                <label>Show:
                    <select id="records-per-page" class="form-control-sm">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                    records
                </label>
            </div>
        </div>
        <div id="table-container" class="table-box">
            <p class="placeholder">Loading data...</p>
        </div>
    </div>
</div>

<style>
.data-controls { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem; max-width: 1400px; margin-left: auto; margin-right: auto; }
.filter-section, .stats-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.time-filters { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; }
.time-filters label { display: block; margin-bottom: 0.75rem; font-weight: 600; color: #374151; }
.btn-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.btn-time { padding: 0.5rem 1rem; background: white; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.btn-time:hover { border-color: #4f46e5; color: #4f46e5; }
.btn-time.active { background: #4f46e5; color: white; border-color: #4f46e5; }
.filters { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.btn-secondary { margin-left: 0.5rem; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; }
.btn-secondary:hover { background: #4b5563; }
.stats-box { padding: 1rem; background: #f9fafb; border-radius: 8px; }
.stat-item { padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-radius: 6px; }
.stat-item strong { color: #4f46e5; }
.data-table-section { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 1400px; margin: 0 auto; }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.table-controls { display: flex; align-items: center; gap: 1rem; }
.form-control-sm { padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
.table-box { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
th { background: #f9fafb; font-weight: 600; color: #374151; position: sticky; top: 0; }
tr:hover { background: #f9fafb; }
#record-count { color: #6b7280; font-size: 0.9rem; font-weight: normal; }
</style>
{% endblock %}

{% block scripts %}
<script>
let currentData = [];

// Time period calculator
function getDateRange(period) {
    const end = new Date();
    const start = new Date();
    
    switch(period) {
        case '1d':
            start.setDate(end.getDate() - 1);
            break;
        case '1w':
            start.setDate(end.getDate() - 7);
            break;
        case '1m':
            start.setMonth(end.getMonth() - 1);
            break;
        case '3m':
            start.setMonth(end.getMonth() - 3);
            break;
        case '6m':
            start.setMonth(end.getMonth() - 6);
            break;
        case 'ytd':
            start.setMonth(0, 1); // January 1st
            break;
        case '1y':
            start.setFullYear(end.getFullYear() - 1);
            break;
        case 'all':
            return { start: null, end: null };
    }
    
    return {
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0]
    };
}

// Time period button handlers
document.querySelectorAll('.btn-time').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
        // Add active to clicked button
        this.classList.add('active');
        
        const period = this.getAttribute('data-period');
        const dateRange = getDateRange(period);
        
        document.getElementById('filter-start-date').value = dateRange.start || '';
        document.getElementById('filter-end-date').value = dateRange.end || '';
        
        loadData();
    });
});

async function loadStatistics() {
    try {
        const response = await fetch('/api/statistics');
        const data = await response.json();
        if (data.success) {
            const stats = data.data;
            const statsContainer = document.getElementById('stats-container');
            
            let currencyBreakdown = '';
            if (stats.currency_breakdown) {
                currencyBreakdown = Object.entries(stats.currency_breakdown)
                    .map(([curr, count]) => `<div class="stat-item"><strong>${curr}:</strong> ${count.toLocaleString()} records</div>`)
                    .join('');
            }
            
            statsContainer.innerHTML = `
                <div class="stat-item"><strong>Total Records:</strong> ${stats.total_records.toLocaleString()}</div>
                <div class="stat-item"><strong>Currencies:</strong> ${stats.currencies}</div>
                <div class="stat-item"><strong>Date Range:</strong> ${stats.date_range.start || 'N/A'} to ${stats.date_range.end || 'N/A'}</div>
                ${currencyBreakdown}
            `;
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadCurrencies() {
    try {
        const response = await fetch('/api/currencies');
        const data = await response.json();
        if (data.success) {
            const select = document.getElementById('filter-currency');
            select.innerHTML = '<option value="">All Currencies</option>' +
                data.data.map(c => `<option value="${c}">${c}</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading currencies:', error);
    }
}

async function loadData() {
    const currency = document.getElementById('filter-currency').value;
    const tenor = document.getElementById('filter-tenor').value;
    const startDate = document.getElementById('filter-start-date').value;
    const endDate = document.getElementById('filter-end-date').value;
    const limit = document.getElementById('records-per-page').value;

    const params = new URLSearchParams();
    if (currency) params.append('currency', currency);
    if (tenor) params.append('tenor', tenor);
    if (startDate) params.append('start_date', startDate);
    if (endDate) params.append('end_date', endDate);
    params.append('limit', limit);

    const tableContainer = document.getElementById('table-container');
    tableContainer.innerHTML = '<p class="placeholder">Loading...</p>';

    try {
        const response = await fetch(`/api/rates?${params}`);
        const data = await response.json();

        if (data.success) {
            currentData = data.data;
            document.getElementById('record-count').textContent = `(${currentData.length} records)`;
            
            if (currentData.length === 0) {
                tableContainer.innerHTML = '<p class="placeholder">No data found</p>';
            } else {
                tableContainer.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Currency</th>
                                <th>Tenor</th>
                                <th>Floating Rate</th>
                                <th>Rate (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentData.map(row => `
                                <tr>
                                    <td>${row.date}</td>
                                    <td>${row.currency}</td>
                                    <td>${row.tenor}</td>
                                    <td>${row.floating_rate}</td>
                                    <td>${row.rate_percent.toFixed(4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        }
    } catch (error) {
        tableContainer.innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
    }
}

// Export to CSV
function exportToCSV() {
    if (currentData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['Date', 'Currency', 'Tenor', 'Floating Rate', 'Rate (%)'];
    const csvContent = [
        headers.join(','),
        ...currentData.map(row => 
            [row.date, row.currency, row.tenor, row.floating_rate, row.rate_percent.toFixed(4)].join(',')
        )
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `swap_rates_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

document.getElementById('filter-currency').addEventListener('change', async (e) => {
    if (e.target.value) {
        const response = await fetch(`/api/tenors/${e.target.value}`);
        const data = await response.json();
        if (data.success) {
            const select = document.getElementById('filter-tenor');
            select.innerHTML = '<option value="">All Tenors</option>' +
                data.data.map(t => `<option value="${t}">${t}</option>`).join('');
        }
    }
});

document.getElementById('apply-filters').addEventListener('click', loadData);
document.getElementById('clear-filters').addEventListener('click', () => {
    document.getElementById('filter-currency').value = '';
    document.getElementById('filter-tenor').value = '';
    document.getElementById('filter-start-date').value = '';
    document.getElementById('filter-end-date').value = '';
    document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
    loadData();
});
document.getElementById('export-csv').addEventListener('click', exportToCSV);
document.getElementById('records-per-page').addEventListener('change', loadData);

loadStatistics();
loadCurrencies();
loadData();
</script>
{% endblock %}
