{% extends "base.html" %}

{% block title %}Interactive Pivot Table - RateEdge{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
<style>
.pivot-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
}
.pivot-controls {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}
.pivot-area {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow-x: auto;
}
.control-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}
.pvtUi { font-size: 0.9rem; }
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}
.loading-spinner {
    background: white;
    padding: 2rem 3rem;
    border-radius: 12px;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="pivot-container">
    <div class="tool-header">
        <h1>ðŸ“Š Interactive Pivot Table</h1>
        <p>Drag and drop fields to analyze swap rate data</p>
    </div>

    <div class="pivot-controls">
        <h2>Data Filters</h2>
        <div class="control-group">
            <div class="form-group">
                <label>Currency</label>
                <select id="filter-currency" class="form-control" multiple size="5">
                    <option value="ALL" selected>All Currencies</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date Range</label>
                <input type="date" id="filter-start-date" class="form-control" style="margin-bottom: 0.5rem;">
                <input type="date" id="filter-end-date" class="form-control">
            </div>
            <div class="form-group">
                <label>Max Records</label>
                <select id="max-records" class="form-control">
                    <option value="1000">1,000</option>
                    <option value="5000" selected>5,000</option>
                    <option value="10000">10,000</option>
                    <option value="50000">50,000</option>
                    <option value="0">All</option>
                </select>
            </div>
        </div>
        <button id="load-data-btn" class="btn-primary">Load Data into Pivot Table</button>
        <button id="export-pivot-btn" class="btn-secondary" style="margin-left: 0.5rem;">Export Current View</button>
    </div>

    <div class="pivot-area">
        <div id="pivot-output"></div>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner">
        <h3>Loading data...</h3>
        <p id="loading-status">Please wait</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/export_renderers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/d3_renderers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/c3_renderers.min.js"></script>

<script>
let pivotData = [];

// Load available currencies
async function loadCurrencies() {
    try {
        const response = await fetch('/api/currencies');
        const data = await response.json();
        if (data.success) {
            const select = $('#filter-currency');
            select.empty();
            select.append('<option value="ALL" selected>All Currencies</option>');
            data.data.forEach(curr => {
                select.append(`<option value="${curr}">${curr}</option>`);
            });
        }
    } catch (error) {
        console.error('Error loading currencies:', error);
    }
}

// Load data for pivot table
async function loadPivotData() {
    const selectedCurrencies = $('#filter-currency').val();
    const startDate = $('#filter-start-date').val();
    const endDate = $('#filter-end-date').val();
    const maxRecords = $('#max-records').val();

    $('#loading-overlay').show();
    $('#loading-status').text('Fetching data...');

    try {
        // Build query parameters
        const params = new URLSearchParams();
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (maxRecords !== '0') params.append('limit', maxRecords);

        // Fetch data for selected currencies
        let allData = [];
        
        if (selectedCurrencies.includes('ALL') || selectedCurrencies.length === 0) {
            // Fetch all currencies
            $('#loading-status').text('Loading all currencies...');
            const response = await fetch(`/api/rates?${params}`);
            const data = await response.json();
            if (data.success) allData = data.data;
        } else {
            // Fetch each currency
            for (let i = 0; i < selectedCurrencies.length; i++) {
                const currency = selectedCurrencies[i];
                $('#loading-status').text(`Loading ${currency} (${i+1}/${selectedCurrencies.length})...`);
                params.set('currency', currency);
                const response = await fetch(`/api/rates?${params}`);
                const data = await response.json();
                if (data.success) allData = allData.concat(data.data);
            }
        }

        $('#loading-status').text(`Processing ${allData.length.toLocaleString()} records...`);
        
        // Transform data for pivot table
        pivotData = allData.map(row => ({
            'Date': row.date.split('T')[0],
            'Currency': row.currency,
            'Tenor': row.tenor,
            'Floating Rate': row.floating_rate,
            'Rate (%)': row.rate_percent,
            'Year': row.date.split('-')[0],
            'Month': row.date.substring(0, 7)
        }));

        renderPivotTable();
        $('#loading-overlay').hide();
    } catch (error) {
        $('#loading-overlay').hide();
        alert(`Error loading data: ${error.message}`);
    }
}

function renderPivotTable() {
    const renderers = $.extend(
        $.pivotUtilities.renderers,
        $.pivotUtilities.export_renderers,
        $.pivotUtilities.d3_renderers,
        $.pivotUtilities.c3_renderers
    );

    $("#pivot-output").pivotUI(pivotData, {
        renderers: renderers,
        rows: ["Currency"],
        cols: ["Tenor"],
        aggregatorName: "Average",
        vals: ["Rate (%)"],
        rendererName: "Table Heatmap",
        unusedAttrsVertical: false,
        onRefresh: function(config) {
            const configCopy = JSON.parse(JSON.stringify(config));
            delete configCopy["aggregators"];
            delete configCopy["renderers"];
            localStorage.setItem("pivotConfig", JSON.stringify(configCopy));
        }
    }, true);

    // Restore previous configuration if exists
    const savedConfig = localStorage.getItem("pivotConfig");
    if (savedConfig) {
        const config = JSON.parse(savedConfig);
        $("#pivot-output").pivotUI(pivotData, $.extend({}, config, {
            renderers: renderers
        }), false, "en");
    }
}

// Export current pivot view
function exportPivot() {
    const table = $('#pivot-output table').first();
    if (!table.length) {
        alert('No pivot table to export');
        return;
    }

    // Convert table to CSV
    let csv = [];
    table.find('tr').each(function() {
        let row = [];
        $(this).find('th, td').each(function() {
            row.push('"' + $(this).text().replace(/"/g, '""') + '"');
        });
        csv.push(row.join(','));
    });

    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pivot_table_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Event listeners
$('#load-data-btn').on('click', loadPivotData);
$('#export-pivot-btn').on('click', exportPivot);

// Initialize
loadCurrencies();

// Set default dates (last year)
const endDate = new Date();
const startDate = new Date();
startDate.setFullYear(endDate.getFullYear() - 1);
$('#filter-end-date').val(endDate.toISOString().split('T')[0]);
$('#filter-start-date').val(startDate.toISOString().split('T')[0]);
</script>
{% endblock %}
